<?php
// Database connection
$conn = new mysqli("localhost", "root", "", "journal");
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

// Create table if not exists
$conn->query("CREATE TABLE IF NOT EXISTS tasks (
    id INT AUTO_INCREMENT PRIMARY KEY,
    task_text VARCHAR(255),
    task_date DATE,
    is_done TINYINT(1) DEFAULT 0
)");

// Add task
if (isset($_POST['add_task'])) {
    $task = trim($_POST['task']);
    $date = $_POST['date'];
    $today = date('Y-m-d');

    if (empty($task)) {
        echo "<script>showModal('No input entered. Please try again.');</script>";
    } elseif ($date < $today) {
        echo "<script>showModal('Invalid date. Please choose today or a future date.');</script>";
    } else {
        $stmt = $conn->prepare("INSERT INTO tasks (task_text, task_date) VALUES (?, ?)");
        $stmt->bind_param("ss", $task, $date);
        $stmt->execute();
        $stmt->close();
        echo "<script>window.location.href='to-do-list.php';</script>";
    }
}

// Delete task
if (isset($_GET['delete'])) {
    $id = intval($_GET['delete']);
    $conn->query("DELETE FROM tasks WHERE id=$id");
    header("Location: to-do-list.php");
}

// Toggle complete
if (isset($_GET['toggle'])) {
    $id = intval($_GET['toggle']);
    $conn->query("UPDATE tasks SET is_done = 1 - is_done WHERE id=$id");
    header("Location: to-do-list.php");
}

// Get all tasks
$tasks = $conn->query("SELECT * FROM tasks ORDER BY task_date ASC");
?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>To-Do Calendar</title>
<style>
body {
    font-family: Arial, sans-serif;
    background: #f3f6fb;
    margin: 0;
    padding: 0;
}
.container {
    width: 90%;
    max-width: 800px;
    margin: 30px auto;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    padding: 20px;
}
input[type="text"] {
    width: 100%;
    height: 50px;
    padding: 10px;
    font-size: 16px;
    border: 2px solid #ddd;
    border-radius: 6px;
}
input[type="date"], button {
    margin-top: 10px;
    padding: 10px;
    font-size: 15px;
}
button {
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}
button:hover { background: #0056b3; }
.calendar {
    margin-top: 30px;
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
}
.day {
    background: #e8eef8;
    border-radius: 8px;
    padding: 5px;
    min-height: 100px;
    position: relative;
    overflow-y: auto;
}
.day h4 {
    font-size: 13px;
    text-align: right;
    margin: 0;
    color: #555;
}
.task {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 3px 6px;
    margin-top: 4px;
    font-size: 14px;
}
.task.done {
    text-decoration: line-through;
    background: #d7ffd7;
}
.task input[type=checkbox] { margin-right: 6px; }
.remove {
    color: red;
    cursor: pointer;
    font-weight: bold;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
}
.modal-content {
    background:#fff;
    padding:20px;
    border-radius:10px;
    text-align:center;
    max-width:300px;
}
</style>
</head>
<body>

<div class="container">
    <form method="POST" onsubmit="return validateForm()">
        <input type="text" name="task" id="task" placeholder="Enter your task...">
        <input type="date" name="date" id="date">
        <button type="submit" name="add_task">Save</button>
    </form>

    <div class="calendar">
        <?php
        $year = date('Y');
        $month = date('m');
        $daysInMonth = date('t', strtotime("$year-$month-01"));

        for ($day = 1; $day <= $daysInMonth; $day++) {
            $date = sprintf("%04d-%02d-%02d", $year, $month, $day);
            echo "<div class='day'><h4>$day</h4>";
            $result = $conn->query("SELECT * FROM tasks WHERE task_date='$date'");
            while ($row = $result->fetch_assoc()) {
                $doneClass = $row['is_done'] ? 'done' : '';
                echo "<div class='task $doneClass'>
                        <div style='display:flex;align-items:center;'>
                            <input type='checkbox' onchange=\"location.href='?toggle={$row['id']}'\" ".($row['is_done']?'checked':'').">
                            <span>{$row['task_text']}</span>
                        </div>
                        <span class='remove' onclick=\"if(confirm('Remove this task?')) location.href='?delete={$row['id']}'\">Ã—</span>
                      </div>";
            }
            echo "</div>";
        }
        ?>
    </div>
</div>

<!-- Modal -->
<div class="modal" id="myModal">
  <div class="modal-content">
    <p id="modalText"></p>
    <button onclick="closeModal()">OK</button>
  </div>
</div>

<script>
function validateForm() {
    const task = document.getElementById('task').value.trim();
    const date = document.getElementById('date').value;
    const today = new Date().toISOString().split('T')[0];

    if (task === "") {
        showModal("No input entered. Please try again.");
        return false;
    }
    if (date < today) {
        showModal("Invalid date. Please choose today or a future date.");
        return false;
    }
    return true;
}

function showModal(msg) {
    document.getElementById("modalText").innerText = msg;
    document.getElementById("myModal").style.display = "flex";
}
function closeModal() {
    document.getElementById("myModal").style.display = "none";
}
</script>

</body>
</html>
